@{
    ViewBag.Title = "Create";
}

@using WebMatrix.Data

@{

    //connect to database
    var db = Database.Open("BoardGame");
    var message = "";

    var fam = db.Query("select * from GameFamily order by Family asc");
    var theme = db.Query("select * from Theme order by ThemeName asc");

    if (IsPost)
    {
        // Collect form values
        var name = Request["Name"];
        var description = Request["Description"];
        var Family = Request["Family"];
        var NewFamily = Request["NewFamily"];
        var Theme = Request["Theme"];
        var NewTheme = Request["NewTheme"];
        var year = Request["YearPublished"];
        var minPlayers = Request["MinPlayers"];
        var maxPlayers = Request["MaxPlayers"];

        //create new bgg id
        var nextId = db.QueryValue("Select isnull(max(BGGId),0) +1 From BoardGame");

        //for new family if selected
        if (Family == "New")
        {
            Family = NewFamily;

            //check if family already exists, if not insert it
            var checkFam = db.QueryValue("SELECT COUNT(*) FROM GameFamily WHERE Family = @0", Family);
            if (checkFam == 0)
            {
                //create FamilyCode like 'F1', 'F2', etc.
                var nextFamCode = db.QueryValue("SELECT 'F' + CAST(ISNULL(COUNT(*),0) + 1 AS NVARCHAR) FROM GameFamily");
                db.Execute("INSERT INTO GameFamily (FamilyCode, Family) VALUES (@0, @1)", nextFamCode, Family);
            }
        }

        //for new theme if selected
        if (Theme == "NewTheme")
        {
            Theme = NewTheme;

            //check if theme already exists
            var checkTheme = db.QueryValue("SELECT COUNT(*) FROM Theme WHERE ThemeName = @0", Theme);
            if (checkTheme == 0)
            {
                //create new ThemeID like 'T1', 'T2', etc.
                var nextThemeId = db.QueryValue("SELECT 'T' + CAST(ISNULL(COUNT(*),0) + 1 AS NVARCHAR) FROM Theme");
                db.Execute("INSERT INTO Theme (ThemeID, ThemeName) VALUES (@0, @1)", nextThemeId, Theme);
            }
        }

        // Insert into database
        db.Execute(@"INSERT INTO BoardGame
             (BGGId, Name, Description, Family, YearPublished, MinPlayers, MaxPlayers)
             VALUES (@0, @1, @2, @3, @4, @5, @6)",
             nextId, name, description, Family, year, minPlayers, maxPlayers);

        message = "Game successfully added!";
    }
}

<h2>Add New Board Game</h2>

@if (!String.IsNullOrEmpty(message))
{
    <div class="alert alert-success">@message</div>
}

<form method="post" action="">
    <div>
        <label>Game Name:</label><br />
        <input type="text" name="Name" class="form-control" required />
    </div>

    <div>
        <label>Description:</label><br />
        <textarea name="Description"></textarea>
    </div>

    <div>
        <label for="Family">Select Existing Family:</label>
        <select id="Family" name="Family" class="form-control">
            <option value="">-- None --</option>
            @foreach (var row in fam)
            {
                <option value="@row.Family">@row.Family</option>
            }
            <option value="New">Add New Family...</option>
        </select>
    </div>

    <div id="newFamilyInput" style="display:none;">
        <label for="NewFamily">New Family Name:</label>
        <input type="text" id="NewFamily" name="NewFamily" class="form-control" />
    </div>

    <div>
        <label for="Theme">Select existing theme:</label>
        <select id="Theme" name="Theme" class="form-control">
            <option value="">-- None --</option>
            @foreach (var row in theme)
            {
                <option value="@row.ThemeName">@row.ThemeName</option>
            }
            <option value="NewTheme">Add New Theme...</option>
        </select>
    </div>

    <div id="newThemeInput" style="display:none;">
        <label for="NewTheme">New Theme Name:</label>
        <input type="text" id="NewTheme" name="NewTheme" class="form-control" />
    </div>

    <div>
        <label>Year Published:</label><br />
        <input type="number" name="YearPublished" />
    </div>

    <div>
        <label>Min Players:</label><br />
        <input type="number" name="MinPlayers" />
    </div>

    <div>
        <label>Max Players:</label><br />
        <input type="number" name="MaxPlayers" />
    </div>

    <br />
    <button type="submit" class="btn btn-primary">Add Game</button>
</form>

<!--show/hide new family field -->
<script>
    document.getElementById("Family").addEventListener("change", function () {
        if (this.value === "New") {
            document.getElementById("newFamilyInput").style.display = "block";
        } else {
            document.getElementById("newFamilyInput").style.display = "none";
        }
    });
</script>

<!--show/hide new theme field -->
<script>
    document.getElementById("Theme").addEventListener("change", function () {
        if (this.value === "NewTheme") {
            document.getElementById("newThemeInput").style.display = "block";
        } else {
            document.getElementById("newThemeInput").style.display = "none";
        }
    });
</script>
