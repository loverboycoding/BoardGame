@{
    ViewBag.Title = "Edit Game";
}

@using WebMatrix.Data

@{
    //connect to database
    var db = Database.Open("BoardGame");
    var message = "";

    //get game id from query
    var bggId = Request["id"];

    if (bggId == null)
    {
        <div class="alert alert-danger">No game selected.</div>
        return;
    }

    //get current game record
    var game = db.QuerySingle("SELECT * FROM BoardGame WHERE BGGId=@0", bggId);

    if (game == null)
    {
        <div class="alert alert-warning">Game not found.</div>
        return;
    }

    //if user submitted the form
    if (IsPost)
    {
        var name = Request["Name"];
        var description = Request["Description"];
        var year = Request["YearPublished"];
        var minPlayers = Request["MinPlayers"];
        var maxPlayers = Request["MaxPlayers"];
        var family = Request["Family"];
        var confirmAdd = Request["ConfirmAdd"];

        //check if the family exists
        var famExists = db.QueryValue("SELECT COUNT(*) FROM GameFamily WHERE Family=@0", family);

        if (famExists == 0 && String.IsNullOrWhiteSpace(confirmAdd))
        {
            //show confirmation message before actually updating
            message = $"Family '{family}' does not exist. Do you want to add it?";
            <form method="post">
                <input type="hidden" name="Name" value="@name" />
                <input type="hidden" name="Description" value="@description" />
                <input type="hidden" name="YearPublished" value="@year" />
                <input type="hidden" name="MinPlayers" value="@minPlayers" />
                <input type="hidden" name="MaxPlayers" value="@maxPlayers" />
                <input type="hidden" name="Family" value="@family" />
                <input type="hidden" name="ConfirmAdd" value="yes" />
                <div class="alert alert-warning">@message</div>
                <button type="submit" class="btn btn-success">Yes, add and update</button>
                <a href="?id=@bggId" class="btn btn-secondary">Cancel</a>
            </form>
            return;
        }

        //if family doesn't exist but user confirmed
        if (famExists == 0 && confirmAdd == "yes")
        {
            //generate new family code
            var newCode = Guid.NewGuid().ToString();
            db.Execute("INSERT INTO GameFamily (FamilyCode, Family) VALUES (@0, @1)", newCode, family);
        }

        //update the game record
        db.Execute(@"UPDATE BoardGame
             SET Name=@0, Description=@1, YearPublished=@2,
                 MinPlayers=@3, MaxPlayers=@4, Family=@5
             WHERE BGGId=@6",
                    name, description, year, minPlayers, maxPlayers, family, bggId);

        message = "Game details updated successfully!";
        game = db.QuerySingle("SELECT * FROM BoardGame WHERE BGGId=@0", bggId);
    }
}

<h2>Edit Game Details</h2>

@if (!String.IsNullOrEmpty(message))
{
    <div class="alert alert-success">@message</div>
}

<form method="post" action="">
    <div class="form-group">
        <label>Game Name:</label>
        <input type="text" name="Name" value="@game.Name" class="form-control" required />
    </div>

    <div class="form-group">
        <label>Description:</label>
        <textarea name="Description" class="form-control">@game.Description</textarea>
    </div>

    <div class="form-group">
        <label>Year Published:</label>
        <input type="number" name="YearPublished" value="@(game.YearPublished != null ? ((DateTime)game.YearPublished).Year.ToString() : "")" class="form-control" />
    </div>

    <div class="form-group">
        <label>Min Players:</label>
        <input type="number" name="MinPlayers" value="@game.MinPlayers" class="form-control" />
    </div>

    <div class="form-group">
        <label>Max Players:</label>
        <input type="number" name="MaxPlayers" value="@game.MaxPlayers" class="form-control" />
    </div>

    <div class="form-group">
        <label>Family:</label>
        <input type="text" name="Family" value="@game.Family" class="form-control" />
    </div>

    <br />
    <button type="submit" class="btn btn-primary">Save Changes</button>
    <a href="/Home/Index" class="btn btn-secondary">Cancel</a>
</form>
